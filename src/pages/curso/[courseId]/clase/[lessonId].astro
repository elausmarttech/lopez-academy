---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { courses } from '@/data/courses';

export function getStaticPaths() {
  const paths: { params: { courseId: string; lessonId: string }; props: { course: typeof courses[0]; lesson: typeof courses[0]['lessons'][0]; lessonIndex: number } }[] = [];
  for (const course of courses) {
    course.lessons.forEach((lesson, index) => {
      paths.push({
        params: { courseId: course.id, lessonId: lesson.id },
        props: { course, lesson, lessonIndex: index },
      });
    });
  }
  return paths;
}

const { course, lesson, lessonIndex } = Astro.props;
const totalLessons = course.lessons.length;
const hasPrev = lessonIndex > 0;
const hasNext = lessonIndex < totalLessons - 1;
const prevLesson = hasPrev ? course.lessons[lessonIndex - 1] : null;
const nextLesson = hasNext ? course.lessons[lessonIndex + 1] : null;
---
<BaseLayout title={`${lesson.title} - ${course.title}`} showFooter={false}>
  <div class="h-full flex flex-col bg-[#F8F7F4] overflow-hidden pb-16 min-h-0">
    <div class="flex-1 flex min-h-0 overflow-hidden">
      <!-- Sidebar: lesson list (independent scroll, collapsible) -->
      <aside
        id="lesson-sidebar"
        class="w-72 lg:w-80 flex-shrink-0 bg-[#F8F7F4] border-r border-gray-200 flex flex-col transition-all duration-300 ease-in-out overflow-hidden"
      >
        <div class="flex-shrink-0 p-4 border-b border-gray-200 bg-white">
          <a href={`/curso/${course.id}`} class="flex items-center gap-2 text-[#2F7FBF] hover:text-[#256A9E] text-sm mb-3">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            Back to course
          </a>
          <p class="font-semibold text-[#2B2B2B] text-base truncate" title={course.title}>{course.title}</p>
          <p class="text-sm text-gray-500">{totalLessons} lessons</p>
        </div>
        <nav class="flex-1 overflow-y-auto p-4 min-h-0">
          {course.lessons.map((l, index) => {
            const isCurrent = l.id === lesson.id;
            return (
              <a
                href={`/curso/${course.id}/clase/${l.id}`}
                class={`block w-full text-left px-4 py-3 rounded-lg mb-2 transition-all ${
                  isCurrent ? 'bg-[#2F7FBF] text-white' : 'hover:bg-white'
                }`}
              >
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0 mt-0.5">
                    {isCurrent ? (
                      <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    ) : (
                      <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/></svg>
                    )}
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class={`font-medium text-sm leading-tight mb-1 ${isCurrent ? 'text-white' : 'text-[#2B2B2B]'}`}>
                      {index + 1}. {l.title}
                    </p>
                    <p class={`text-xs ${isCurrent ? 'text-white/70' : 'text-gray-500'}`}>{l.duration}</p>
                  </div>
                </div>
              </a>
            );
          })}
        </nav>
      </aside>

      <!-- Main content: video + text -->
      <main class="flex-1 flex flex-col min-w-0 overflow-y-auto">
        <div class="p-6 lg:p-8">
          <div class="max-w-4xl mx-auto">
            <div class="w-full aspect-video bg-[#E0DDD5] rounded-lg flex items-center justify-center shadow-sm border border-gray-200/50 overflow-hidden">
              <div class="text-center p-6">
                <div class="w-16 h-16 bg-[#2F7FBF] rounded-full flex items-center justify-center mx-auto mb-4 hover:bg-[#256A9E] transition-colors cursor-pointer">
                  <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </div>
                <p class="text-[#2B2B2B] font-medium mb-1">{lesson.title}</p>
                <p class="text-gray-600 text-sm">Duration: {lesson.duration}</p>
              </div>
            </div>
          </div>
        </div>

        {/* Additional text */}
        {lesson.content && (
          <div class="bg-white p-6 lg:p-10">
            <article class="max-w-2xl mx-auto">
              <div class="lesson-content text-[#2B2B2B] text-base lg:text-lg leading-[1.7] whitespace-pre-line">
                {lesson.content}
              </div>
            </article>
          </div>
        )}
      </main>
    </div>

    <!-- Fixed bottom bar: Previous / Next + collapse button -->
    <footer class="fixed bottom-0 left-0 right-0 bg-[#2B2B2B] text-white px-6 py-3 flex items-center justify-between shadow-lg z-20">
      <div class="max-w-4xl mx-auto w-full flex items-center justify-between gap-4">
        <div>
          {hasPrev ? (
            <a
              href={`/curso/${course.id}/clase/${prevLesson!.id}`}
              class="flex items-center gap-2 px-4 py-2 text-gray-300 hover:text-white hover:bg-white/10 rounded-lg transition-colors text-sm"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
              Previous
            </a>
          ) : (
            <span class="px-4 py-2 text-gray-500 text-sm">Previous</span>
          )}
        </div>
        <div class="flex items-center gap-3">
          <span class="text-gray-400 text-sm hidden sm:inline">Lesson {lessonIndex + 1} of {totalLessons}</span>
          {hasNext ? (
            <a
              href={`/curso/${course.id}/clase/${nextLesson!.id}`}
              class="flex items-center gap-2 px-5 py-2.5 bg-white text-[#2B2B2B] rounded-lg hover:bg-gray-200 transition-colors font-medium text-sm"
            >
              Next
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </a>
          ) : (
            <a
              href={`/curso/${course.id}`}
              class="flex items-center gap-2 px-5 py-2.5 bg-white text-[#2B2B2B] rounded-lg hover:bg-gray-200 transition-colors font-medium text-sm"
            >
              Finish
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </a>
          )}
          <button
            type="button"
            id="toggle-sidebar"
            class="p-2 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 transition-colors"
            title="Collapse/expand lesson list"
          >
            <svg id="icon-collapse" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/></svg>
            <svg id="icon-expand" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/></svg>
          </button>
        </div>
      </div>
    </footer>
  </div>

  <script>
    const sidebar = document.getElementById('lesson-sidebar');
    const toggleBtn = document.getElementById('toggle-sidebar');
    const iconExpand = document.getElementById('icon-expand');
    const iconCollapse = document.getElementById('icon-collapse');
    toggleBtn?.addEventListener('click', () => {
      if (!sidebar) return;
      const isHidden = sidebar.classList.contains('sidebar-collapsed');
      if (isHidden) {
        sidebar.classList.remove('sidebar-collapsed');
        sidebar.style.width = '';
        sidebar.style.minWidth = '';
        iconExpand?.classList.remove('hidden');
        iconCollapse?.classList.add('hidden');
      } else {
        sidebar.classList.add('sidebar-collapsed');
        sidebar.style.width = '0';
        sidebar.style.minWidth = '0';
        sidebar.style.overflow = 'hidden';
        sidebar.style.padding = '0';
        iconExpand?.classList.add('hidden');
        iconCollapse?.classList.remove('hidden');
      }
    });
  </script>
</BaseLayout>

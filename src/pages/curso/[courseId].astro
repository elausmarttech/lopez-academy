---
import BaseLayout from '@/layouts/BaseLayout.astro';

export const prerender = false;
const { courseId } = Astro.params;
---
<BaseLayout title="Curso - AprendePlus">
  <div id="curso-detail-root" class="min-h-screen bg-white" data-course-id={courseId ?? ''}>
    <section class="bg-[#2B2B2B] text-white py-12">
      <div class="max-w-7xl mx-auto px-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-2" id="course-hero">
            <p class="text-gray-400 text-sm mb-2">Loading...</p>
          </div>
          <div class="lg:col-span-1">
            <div class="bg-white rounded-xl p-6 text-[#2B2B2B] sticky top-24" id="course-actions">
              <p class="text-gray-500 text-sm">Loading...</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="py-12">
      <div class="max-w-4xl mx-auto px-6">
        <h2 class="text-2xl font-bold text-[#2B2B2B] mb-6">Course outline</h2>
        <div id="course-items" class="space-y-3">
          <p class="text-gray-500">Loading...</p>
        </div>
      </div>
    </section>
    <div id="course-error" class="hidden max-w-4xl mx-auto px-6 text-red-600"></div>
  </div>

  <script>
    import { get } from '@/lib/api';
    import type { CourseDetail } from '@/lib/api-types';

    const root = document.getElementById('curso-detail-root');
    const courseId = root?.getAttribute('data-course-id') ?? '';

    function escapeHtml(s: string): string {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    async function load() {
      const hero = document.getElementById('course-hero');
      const actions = document.getElementById('course-actions');
      const itemsEl = document.getElementById('course-items');
      const errorEl = document.getElementById('course-error');

      try {
        const course = await get<CourseDetail>(`/courses/${courseId}`);
        if (hero) {
          hero.innerHTML = `
            <h1 class="text-4xl font-bold mb-4">${escapeHtml(course.title)}</h1>
            <p class="text-gray-300 text-lg leading-relaxed">${escapeHtml(course.description || '')}</p>
          `;
        }
        if (actions) {
          const hasCompletedItems = course.course_items?.some(item => item.completed) ?? false;
          const buttonText = hasCompletedItems ? 'Continue course' : 'Start course';
          actions.innerHTML = `
            <a href="/curso/${courseId}/item" class="w-full bg-[#2F7FBF] text-white py-4 rounded-lg hover:bg-[#256A9E] transition-colors flex items-center justify-center gap-2 mb-3">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
              ${buttonText}
            </a>
            <p class="text-center text-sm text-gray-600">${course.course_items?.length ?? 0} items in course</p>
          `;
        }
        if (itemsEl && course.course_items?.length) {
          const nextItemId = course.next_item?.id ?? null;
          itemsEl.innerHTML = course.course_items
            .map(
              (item, i) => {
                const isCompleted = item.completed;
                const isNext = item.id === nextItemId;
                const isLocked = !isCompleted && !isNext;
                if (isNext) {
                  return `
                    <a href="/curso/${courseId}/item" class="border-2 border-[#2F7FBF] rounded-lg px-6 py-4 flex items-center gap-4 bg-[#2F7FBF]/5 hover:bg-[#2F7FBF]/10 transition-colors">
                      <div class="w-8 h-8 bg-[#2F7FBF] text-white rounded-full flex items-center justify-center text-sm font-semibold flex-shrink-0">${i + 1}</div>
                      <span class="text-xs text-[#2F7FBF] font-medium">${item.item_type}</span>
                      <p class="font-medium text-[#2B2B2B] flex-1">${escapeHtml(item.title)}</p>
                      <span class="text-[#2F7FBF] text-sm font-medium">Comenzar â†’</span>
                    </a>
                  `;
                }
                if (isCompleted) {
                  return `
                    <a href="/curso/${courseId}/item/${item.id}" class="border border-gray-200 rounded-lg px-6 py-4 flex items-center gap-4 bg-gray-50 hover:bg-gray-100 transition-colors">
                      <div class="w-8 h-8 bg-green-100 text-green-700 rounded-full flex items-center justify-center text-sm flex-shrink-0">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                      </div>
                      <span class="text-xs text-gray-500 font-medium">${item.item_type}</span>
                      <p class="font-medium text-gray-600 flex-1">${escapeHtml(item.title)}</p>
                      <span class="text-green-600 text-sm font-medium">Completed</span>
                    </a>
                  `;
                }
                return `
                  <div class="border border-gray-200 rounded-lg px-6 py-4 flex items-center gap-4 opacity-50 cursor-not-allowed select-none" title="Complete the previous items first">
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-sm font-semibold text-gray-400 flex-shrink-0">${i + 1}</div>
                    <span class="text-xs text-gray-400 font-medium">${item.item_type}</span>
                    <p class="font-medium text-gray-400 flex-1">${escapeHtml(item.title)}</p>
                    <span class="text-gray-400 text-sm">Locked</span>
                  </div>
                `;
              }
            )
            .join('');
        } else if (itemsEl) {
          itemsEl.innerHTML = '<p class="text-gray-500">No items in this course.</p>';
        }
        document.title = `${course.title} - AprendePlus`;
      } catch (e: unknown) {
        const err = e as { status?: number; body?: { error?: string; errors?: string[] } };
        const msg = err?.body?.error || (Array.isArray(err?.body?.errors) && err.body.errors[0]) || 'Error loading course';
        if (errorEl) {
          errorEl.textContent = msg;
          errorEl.classList.remove('hidden');
        }
        if (hero) hero.innerHTML = `<p class="text-red-300">${escapeHtml(msg)}</p>`;
        if (itemsEl) itemsEl.innerHTML = '';
      }
    }

    if (courseId) load();
  </script>
</BaseLayout>

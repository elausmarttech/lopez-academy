---
import Layout from '../../../../layouts/Layout.astro';

export const prerender = false;
const { courseId } = Astro.params;
---
<Layout title="Course lessons - AprendePlus" currentPath="/admin">
  <div id="admin-lecciones-root" class="min-h-screen bg-white py-12" data-course-id={courseId ?? ''}>
    <div class="max-w-4xl mx-auto px-6">
      <div class="mb-8">
        <a id="back-edit" href="#" class="inline-flex items-center gap-2 text-[#2F7FBF] hover:underline mb-4">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
          Back to edit course
        </a>
        <h1 id="lecciones-title" class="text-3xl font-bold text-[#2B2B2B] mb-2">Course lessons</h1>
        <p class="text-gray-600">Manage lessons and quizzes. Add new ones or edit content.</p>
      </div>

      <div id="lecciones-error" class="hidden mb-4 p-3 bg-red-50 text-red-700 rounded-lg"></div>
      <div id="lecciones-loading" class="text-gray-500">Loading...</div>

      <div id="lecciones-content" class="hidden">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between bg-[#FFF0CE]/30 rounded-t-xl">
          <p id="items-count" class="text-sm font-medium text-[#2B2B2B]">0 items</p>
          <div class="flex gap-2">
            <a id="link-nueva-leccion" href="#" class="flex items-center gap-2 px-4 py-2 bg-[#2F7FBF] text-white rounded-lg hover:bg-[#256A9E] text-sm font-medium">+ Lesson</a>
            <a id="link-nuevo-quiz" href="#" class="flex items-center gap-2 px-4 py-2 bg-[#E2BC73] text-[#2B2B2B] rounded-lg hover:bg-[#d4a85f] text-sm font-medium">+ Quiz</a>
          </div>
        </div>
        <div id="items-list" class="divide-y divide-gray-200 border border-gray-200 border-t-0 rounded-b-xl overflow-hidden"></div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { get } from '@/lib/api';
  import type { AdminCourseWithItems, AdminCourseItem } from '@/lib/api-types';

  const root = document.getElementById('admin-lecciones-root');
  const courseId = root?.getAttribute('data-course-id') ?? '';

  const backEdit = document.getElementById('back-edit');
  const titleEl = document.getElementById('lecciones-title');
  const loadingEl = document.getElementById('lecciones-loading');
  const contentEl = document.getElementById('lecciones-content');
  const listEl = document.getElementById('items-list');
  const countEl = document.getElementById('items-count');
  const errorEl = document.getElementById('lecciones-error');
  const linkNuevaLeccion = document.getElementById('link-nueva-leccion');
  const linkNuevoQuiz = document.getElementById('link-nuevo-quiz');

  function showError(msg: string) {
    if (errorEl) {
      errorEl.textContent = msg;
      errorEl.classList.remove('hidden');
    }
  }

  function escapeHtml(s: string): string {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  async function load() {
    try {
      const course = await get<AdminCourseWithItems>(`/admin/courses/${courseId}`);
      if (backEdit) backEdit.setAttribute('href', `/admin/curso/${courseId}/editar`);
      if (titleEl) titleEl.textContent = `Lessons: ${course.title}`;
      if (linkNuevaLeccion) linkNuevaLeccion.setAttribute('href', `/admin/curso/${courseId}/leccion/nueva`);
      if (linkNuevoQuiz) linkNuevoQuiz.setAttribute('href', `/admin/curso/${courseId}/quiz/nuevo`);

      const items = (course.course_items ?? []).sort((a, b) => (a.position ?? 0) - (b.position ?? 0));
      if (countEl) countEl.textContent = `${items.length} items`;

      if (listEl) {
        listEl.innerHTML = items
          .map(
            (it) => `
          <a href="${it.item_type === 'Lesson' ? `/admin/curso/${courseId}/leccion/${it.item_id}/editar` : `/admin/curso/${courseId}/quiz/${it.item_id}/editar`}" class="flex items-center gap-4 p-4 hover:bg-[#FFF0CE]/20 transition-colors block">
            <div class="w-10 h-10 bg-[#EEEEEE] rounded-full flex items-center justify-center text-sm font-semibold text-[#2B2B2B] flex-shrink-0">${it.position ?? 0}</div>
            <span class="text-xs font-medium text-[#2F7FBF]">${it.item_type}</span>
            <div class="flex-1 min-w-0">
              <p class="font-medium text-[#2B2B2B]">${escapeHtml(it.item?.title ?? '')}</p>
            </div>
            <span class="text-[#2F7FBF] text-sm font-medium">Edit â†’</span>
          </a>
        `
          )
          .join('');
      }

      if (loadingEl) loadingEl.classList.add('hidden');
      if (contentEl) contentEl.classList.remove('hidden');
    } catch (e: unknown) {
      const err = e as { status?: number; body?: { error?: string } };
      if (err.status === 403) {
        window.location.href = '/admin/forbidden';
        return;
      }
      if (loadingEl) loadingEl.textContent = 'Error loading.';
      showError(err?.body?.error || 'Error loading');
    }
  }

  if (courseId) load();
</script>

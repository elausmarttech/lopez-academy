---
import '../styles/index.css';
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <title>Sign in - AprendePlus</title>
  </head>
  <body>
    <div class="min-h-screen bg-gradient-to-br from-[#123859] to-white flex items-center justify-center px-6 py-12">
      <div class="w-full max-w-md">
        <div class="text-center mb-5">
          <a href="https://lopezinsurance.com/" class="inline-block focus:outline-none focus:ring-2 focus:ring-[#2F7FBF] focus:ring-offset-2 rounded-xl">
            <img
              src="/logo.png"
              alt="López A Insura & Tax - Learning"
              class="mx-auto w-full max-w-[620px] h-auto rounded-xl object-contain drop-shadow-sm"
            />
          </a>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-8">
          <div id="login-error" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>
          <form id="login-form" class="space-y-6">
            <div>
              <label for="email" class="block text-sm font-medium text-[#2B2B2B] mb-2">Email</label>
              <div class="relative">
                <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                <input
                  type="email"
                  id="email"
                  name="email"
                  class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2F7FBF] focus:border-transparent"
                  placeholder="tu@email.com"
                  required
                />
              </div>
            </div>

            <div>
              <label for="password" class="block text-sm font-medium text-[#2B2B2B] mb-2">Password</label>
              <div class="relative">
                <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                <input
                  type="password"
                  id="password"
                  name="password"
                  class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#2F7FBF] focus:border-transparent"
                  placeholder="••••••••"
                  required
                />
              </div>
            </div>

            <button
              type="submit"
              class="w-full bg-[#2F7FBF] text-white py-3 rounded-lg hover:bg-[#256A9E] transition-colors font-medium cursor-pointer"
            >
              Sign in
            </button>
          </form>
        </div>

        <p class="text-center text-sm text-gray-500 mt-6">
          By continuing, you agree to our{' '}
          <a href="#" class="text-[#2F7FBF] hover:underline">Terms of use</a> and{' '}
          <a href="#" class="text-[#2F7FBF] hover:underline">Privacy policy</a>
        </p>
      </div>
    </div>
    <script>
      (function () {
        // If already logged in, go to catalog instead of showing login (avoids confusion and backend bugs)
        try {
          if (typeof localStorage !== 'undefined' && localStorage.getItem('lopez_academy_jwt')) {
            window.location.replace('/cursos');
            return;
          }
        } catch (_) {}

        const form = document.getElementById('login-form') as HTMLFormElement;
        const errorEl = document.getElementById('login-error') as HTMLDivElement;
        if (!form) return;

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = (form.querySelector('#email') as HTMLInputElement)?.value?.trim();
          const password = (form.querySelector('#password') as HTMLInputElement)?.value;
          if (!email || !password) return;

          if (errorEl) {
            errorEl.classList.add('hidden');
            errorEl.textContent = '';
          }

          const base = (import.meta as unknown as { env: { VITE_API_URL?: string } }).env?.VITE_API_URL?.replace(/\/$/, '') || 'https://lopez-university-db.onrender.com';
          const res = await fetch(`${base}/users/sign_in`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify({ user: { email, password } }),
          });

          if (res.ok) {
            const auth = res.headers.get('Authorization');
            const token = auth?.replace(/^Bearer\s+/i, '').trim();
            if (token) {
              try {
                localStorage.setItem('lopez_academy_jwt', token);
              } catch (_) {}
            }
            const baseUrl = base;
            const check = await fetch(`${baseUrl}/admin/courses`, {
              headers: { Accept: 'application/json', Authorization: `Bearer ${token}` },
            });
            window.location.href = check.ok ? '/admin' : '/cursos';
            return;
          }

          if (res.status === 401 && errorEl) {
            let msg = 'Invalid credentials';
            try {
              const data = await res.json();
              if (data?.error) msg = data.error;
              else if (Array.isArray(data?.errors) && data.errors.length) msg = data.errors[0];
            } catch (_) {}
            errorEl.textContent = msg;
            errorEl.classList.remove('hidden');
          }
        });
      })();
    </script>
  </body>
</html>
